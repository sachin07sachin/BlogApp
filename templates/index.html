{% extends "base.html" %}

{% block header %}
<header
  class="masthead"
  style="background-image: url('{{ url_for('static', filename='assets/img/home-bg.jpg') }}')"
>
  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="site-heading">
          <h1>{{ page_title | default("Blog") }}</h1>
          <span class="subheading">A collection of random musings.</span>
          {% if search_message %}
            <h3 class="search-badge mt-3">
              {{ search_message }}
            </h3>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</header>
{% endblock %}

{% block content %}
<div class="container px-4 px-lg-5">
  <div class="row gx-4 gx-lg-5 justify-content-center">
    <div class="col-md-10 col-lg-8 col-xl-7">

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% if all_posts|length > 0 %}

      {% for post in all_posts %}
        <div class="post-preview">
          <a href="{{ url_for('show_post', post_id=post.id) }}">
            <h2 class="post-title">{{ post.title }}</h2>
            <h3 class="post-subtitle">{{ post.subtitle }}</h3>
          </a>

          <p class="post-meta">
            Posted by <b>{{ post.author.name }}</b>
            on {{ post.date.strftime('%B %d, %Y') }}

            {% if current_user.is_authenticated and current_user.role == "admin" %}
              <a 
                 href="{{ url_for('warn_post_author', post_id=post.id) }}" 
                 class="btn btn-warning btn-sm ms-3"
                 style="font-size: 0.7rem;"
              >
                 Warn
              </a>
            {% endif %}

            {% if current_user.is_authenticated and (current_user.id == post.author.id or current_user.role == "admin") %}
              <form
                method="POST"
                action="{{ url_for('delete_post', post_id=post.id) }}"
                class="d-inline"
                onsubmit="return confirm('Are you sure you want to delete this post?');"
              >
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button
                  type="submit"
                  class="btn btn-danger btn-sm ms-2"
                  style="font-size: 0.7rem;"
                >
                  Delete
                </button>
              </form>
            {% endif %}
          </p>
        </div>

        <hr class="my-4" />
      {% endfor %}

      {% if current_user.is_authenticated %}
        <div class="d-flex justify-content-end mb-4">
          <a class="btn btn-primary" href="{{ url_for('add_new_post') }}">
            Create New Post
          </a>
        </div>
      {% endif %}

      {% else %}

        <div class="text-center py-5 my-3">
              <div class="mb-3">
                  <i class="bi bi-journal-x display-1 text-muted opacity-50"></i>
              </div>
              <h3 class="fw-bold text-muted">No posts published yet</h3>
              <p class="text-muted mb-4 lead">It feels a little quiet in here.</p>
              
              {% if current_user.is_authenticated %}
                  <a href="{{ url_for('add_new_post') }}" class="btn btn-primary btn-lg rounded-pill px-4 shadow-sm">
                      <i class="bi bi-pen-fill me-2"></i>Write the First Post
                  </a>
              {% else %}
                  <p class="text-muted small">
                      Check back later for updates or 
                      <a href="{{ url_for('login_get') }}" class="text-decoration-none">log in</a> 
                      to start writing.
                  </p>
              {% endif %}
          </div>

      {% endif %}

    </div>
  </div>
</div>
{% endblock %}
