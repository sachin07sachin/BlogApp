{% extends "base.html" %} 

{% block header %}

<style>
  /* Fix for the border disappearing on focus */
  .input-group .form-control:focus {
    z-index: 3; /* Places focused input ring above others */
  }
  
  .input-group .btn-outline-secondary {
    border-color: #ced4da; /* Force consistent border color with input */
    z-index: 2;
  }

  /* FIXED: Added high z-index and forced border visibility for the eye button */
  .input-group:focus-within .btn-outline-secondary {
    border-color: #80c2d0; /* Matches your theme focus color */
    z-index: 5 !important; /* Forces the button borders to stay above the input glow */
  }

  /* Making footer links stand out */
  .auth-link {
    color: #0085A1; /* Your theme teal */
    font-weight: 600;
    transition: all 0.2s ease;
    text-decoration: none;
  }
  
  .auth-link:hover {
    color: #005f73; /* Darker teal on hover */
    text-decoration: underline !important;
  }

  .auth-footer-text {
    color: #6c757d;
  }
</style>

<header class="masthead" style="background-image: url('{{ url_for('static', filename='assets/img/login-bg.jpg') }}')">
  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="page-heading">
          <h1>Log In</h1>
          <span class="subheading">Welcome Back!</span>
        </div>
      </div>
    </div>
  </div>
</header>
{% endblock %} 

{% block content %}

<main class="mb-4">
  <div class="container">
    <div class="row justify-content-center">
      
      <div class="col-lg-8 col-md-10">
        {% with messages = get_flashed_messages(with_categories=true) %} 
          {% if messages %} 
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %} 
          {% endif %} 
        {% endwith %}
      </div>

      <div class="col-lg-6 col-md-8 mx-auto">
        <div class="card border-0 shadow rounded-3 my-3">
            <div class="card-body p-4 p-sm-5">
                <h3 class="card-title text-center mb-4 fw-light fs-4">Sign In</h3>

                <form method="POST" action="{{ url_for('login_post', next=request.args.get('next')) }}" novalidate>
                  {{ login_form.hidden_tag() }}

                  <div class="form-floating mb-3">
                    {{ login_form.email(class="form-control", placeholder="Enter your email") }} 
                    {{ login_form.email.label() }} 
                    
                    {% if login_form.email.errors %}
                    <div class="text-danger mt-1">
                      {% for error in login_form.email.errors %}
                      <small><i class="bi bi-exclamation-circle"></i> {{ error }}</small>
                      {% endfor %}
                    </div>
                    {% endif %}
                  </div>

                  <div class="mb-3">
                    <div class="input-group">
                        <div class="form-floating flex-grow-1">
                            {{ login_form.password(class="form-control", id="password-field", placeholder="Enter your password") }}
                            {{ login_form.password.label() }}
                        </div>
                        <button class="btn btn-outline-secondary px-3" type="button" id="btn-toggle-password">
                            <i class="bi bi-eye" id="eye-icon"></i>
                        </button>
                    </div>
                    
                    {% if login_form.password.errors %}
                    <div class="text-danger mt-1">
                      {% for error in login_form.password.errors %}
                      <small><i class="bi bi-exclamation-circle"></i> {{ error }}</small>
                      {% endfor %}
                    </div>
                    {% endif %}
                  </div>

                  {# üîê CAPTCHA ‚Äî only when required #} 
                  {% if captcha_required and hcaptcha_site_key %}
                  <div class="mb-3 text-center">
                    <div class="h-captcha" data-sitekey="{{ hcaptcha_site_key }}"></div>
                    <script src="https://hcaptcha.com/1/api.js" async defer></script>
                  </div>
                  {% endif %}

                  <div class="d-grid mt-4">
                    <button type="submit" id="loginBtn" class="btn btn-primary btn-lg text-uppercase fw-bold" style="letter-spacing: 1px;">
                        Log In
                    </button>
                  </div>
                </form>
            </div>

            <div class="card-footer text-center py-4 border-0 bg-transparent">
                <div class="d-flex flex-column gap-3">
                    <p class="small mb-0">
                        <a href="{{ url_for('request_reset_get') }}" class="auth-link">Forgot Password?</a>
                    </p>
                    <p class="small mb-0 auth-footer-text">
                        Don't have an account? 
                        <a href="{{ url_for('register') }}" class="auth-link link-primary">Register</a>
                    </p>
                    <p class="small mb-0 auth-footer-text">
                        Need to verify email? 
                        <a href="{{ url_for('resend_verification_get') }}" class="auth-link">Resend Link</a>
                    </p>
                </div>
            </div>
        </div>
      </div>
      
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    // Logic for Single Password Field
    const toggleBtn = document.getElementById('btn-toggle-password');
    const passField = document.getElementById('password-field');
    const eyeIcon = document.getElementById('eye-icon');

    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            const type = passField.getAttribute('type') === 'password' ? 'text' : 'password';
            passField.setAttribute('type', type);
            
            // Toggle Icon Class
            if (type === 'text') {
                eyeIcon.classList.remove('bi-eye');
                eyeIcon.classList.add('bi-eye-slash');
            } else {
                eyeIcon.classList.remove('bi-eye-slash');
                eyeIcon.classList.add('bi-eye');
            }
        });
    }

    // --- 2. NEW: AUTO-SCROLL TO ERRORS/ALERTS ---
    document.addEventListener("DOMContentLoaded", () => {
        // Target the main container to ensure we scroll high enough to see the alert
        const mainContainer = document.querySelector("main"); 
        
        // Check for Flash Messages (Bootstrap Alerts)
        const hasFlashMessages = document.querySelector(".alert");
        
        // Check for Validation Errors (Text Danger under fields)
        const hasValidationErrors = document.querySelector(".text-danger");

        // If the container exists AND (we have an alert OR a form error)
        if (mainContainer && (hasFlashMessages || hasValidationErrors)) {
            // Smoothly scroll to the top of the main section
            mainContainer.scrollIntoView({ behavior: "smooth", block: "start" });
        }
    });
</script>
{% endblock %}
