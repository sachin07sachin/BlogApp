{% extends "base.html" %}

{% block title %}Inbox | Blog App{% endblock %}

{% block styles %}
<style>
    /* 1. Integrated Container Layout */
    .inbox-container {
        /*margin-top: -10px;*/
        position: relative;
        z-index: 5;
        padding-bottom: 3rem;
    }

    /* 2. Enhanced Card Styling */
    .inbox-card {
        border-radius: 16px;
        background: #ffffff;
        overflow: hidden;
        /* Using a more diffused 'Soft Shadow' common in premium UI */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08) !important;
    }

    /* 3. Modern List Item States */
    .conversation-item {
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        border-bottom: 1px solid #f0f0f0 !important;
        background-color: #fff;
    }

    .conversation-item:last-child {
        border-bottom: none !important;
    }

    .conversation-item:hover {
        background-color: #fcfcfc;
        transform: translateY(-2px); /* Lift effect on hover */
        box-shadow: inset 0 0 10px rgba(0,0,0,0.02);
    }

    /* 4. Notification & Unread Logic */
    .unread-active {
        background-color: rgba(0, 133, 161, 0.02) !important;
        border-left: 4px solid #0085A1 !important;
    }

    /* 5. Avatar & Badge Refinement */
    .avatar-wrapper {
        position: relative;
    }

    .avatar-img {
        object-fit: cover;
        border: 2px solid #fff;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        transition: transform 0.2s ease;
    }

    .conversation-item:hover .avatar-img {
        transform: scale(1.05);
    }

    .unread-badge {
        font-size: 0.75rem;
        font-weight: 700;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* 6. Typography & Text Control */
    .partner-name {
        font-size: 1.1rem;
        letter-spacing: -0.01em;
        color: #1a1a1a;
    }

    .last-message-preview {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
        font-size: 0.95rem;
        line-height: 1.4;
        color: #6c757d;
    }

    .timestamp-small {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* 7. Empty State Refinement */
    .empty-state-icon {
        background: #f8f9fa;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin: 0 auto 1.5rem;
        color: #adb5bd;
    }
</style>
{% endblock %}

{% block header %}
<header class="masthead" style="background-image: url('{{ url_for('static', filename='assets/img/home-bg.jpg') }}')">
    <div class="container position-relative px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                <div class="site-heading">
                    <h1>Inbox</h1>
                    <span class="subheading">Your Conversations</span>
                </div>
            </div>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="container px-4 px-lg-5 mb-5 inbox-container">
    <div class="row gx-4 gx-lg-5 justify-content-center">
        <div class="col-md-11 col-lg-9 col-xl-8"> <div class="card inbox-card border-0 shadow-lg">
                <div class="list-group list-group-flush">
                    {% if conversations %}
                        {% for partner_id, data in conversations.items() %}
                            <a href="{{ url_for('chat', user_id=partner_id) }}" 
                               class="list-group-item list-group-item-action p-4 conversation-item d-flex align-items-center {% if data.unread_count > 0 %}unread-active{% endif %}">
                                
                                <div class="flex-shrink-0 avatar-wrapper">
                                    <img src="{{ data.user.email | gravatar }}" 
                                         alt="{{ data.user.name }}" 
                                         class="rounded-circle avatar-img" 
                                         width="60" height="60">
                                    
                                    {% if data.unread_count > 0 %}
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger unread-badge">
                                            {{ data.unread_count }}
                                        </span>
                                    {% endif %}
                                </div>

                                <div class="ms-4 flex-grow-1">
                                    <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                                        <h6 class="partner-name mb-0 fw-bold">
                                            {{ data.user.name }}
                                        </h6>
                                        
                                        <small class="text-muted smart-date timestamp-small" 
                                               data-utc="{{ data.last_message.timestamp.isoformat() }}">
                                               {{ data.last_message.timestamp.strftime('%d %b %Y') }}
                                        </small>
                                    </div>
                                    
                                    <div class="last-message-preview">
                                        {% if data.last_message.sender_id == current_user.id %}
                                            <span class="text-primary fw-bold" style="font-size: 0.85rem;">You:</span>
                                        {% endif %}
                                        {{ data.last_message.body }}
                                    </div>
                                </div>
                                
                                {#<div class="ms-3 text-muted opacity-25 d-none d-md-block">
                                    <i class="bi bi-chevron-right fs-4"></i>
                                </div>#}
                            </a>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5 px-4">
                            <div class="empty-state-icon">
                                <i class="bi bi-chat-right-dots fs-1"></i>
                            </div>
                            <h5 class="fw-bold text-dark">No messages yet</h5>
                            <p class="text-muted mx-auto" style="max-width: 400px;">Connect with other authors. Visit a profile to start your first conversation!</p>
                            <a href="{{ url_for('get_all_posts') }}" class="btn btn-primary px-4 py-2 rounded-pill mt-3 shadow-sm">
                                Explore the Blog
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}
