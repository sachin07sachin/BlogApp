{% extends "base.html" %} {% block title %}Inbox | Blog App{% endblock %} {%
block styles %}
<style>
  /* 1. Integrated Container Layout */
  .inbox-container {
    /*margin-top: -10px;*/
    position: relative;
    z-index: 5;
    padding-bottom: 3rem;
  }

  /* 2. Enhanced Card Styling */
  .inbox-card {
    border-radius: 16px;
    background: #ffffff;
    overflow: hidden;
    /* Using a more diffused 'Soft Shadow' common in premium UI */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08) !important;
  }

  /* 3. Modern List Item States */
  .conversation-item {
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    border-bottom: 1px solid #f0f0f0 !important;
    background-color: #fff;
  }

  .conversation-item:last-child {
    border-bottom: none !important;
  }

  .conversation-item:hover {
    background-color: #fcfcfc;
    transform: translateY(-2px); /* Lift effect on hover */
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.02);
  }

  /* 4. Notification & Unread Logic */
  .unread-active {
    background-color: rgba(0, 133, 161, 0.02) !important;
    border-left: 4px solid #0085a1 !important;
  }

  /* 5. Avatar & Badge Refinement */
  .avatar-wrapper {
    position: relative;
  }

  .avatar-img {
    object-fit: cover;
    border: 2px solid #fff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
  }

  .conversation-item:hover .avatar-img {
    transform: scale(1.05);
  }

  .unread-badge {
    font-size: 0.75rem;
    font-weight: 700;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* 6. Typography & Text Control */
  /* Utility to ensure Flexbox allows text truncation */
  .text-content-wrapper {
    min-width: 0;
  }

  .partner-name {
    font-size: 1.1rem;
    letter-spacing: -0.01em;
    color: #1a1a1a;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: 8px;
  }

  .last-message-preview {
    /* Use Flexbox Logic for Truncation */
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Show exactly 2 lines then ... */
    -webkit-box-orient: vertical;
    overflow: hidden;

    /* Allow wrapping to next line */
    white-space: normal;

    /* CRITICAL FIX: Break long words (ggggg...) so they don't break layout */
    word-break: break-word;

    font-size: 0.95rem;
    line-height: 1.4;
    color: #6c757d;
    margin-top: 4px;
    padding-right: 20px;
  }

  .timestamp-small {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    white-space: nowrap; /* Prevent date wrapping */
    flex-shrink: 0; /* Prevent date squishing */
  }

  /* 7. Empty State Refinement */
  .empty-state-icon {
    background: #f8f9fa;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin: 0 auto 1.5rem;
    color: #adb5bd;
  }
</style>
{% endblock %} {% block header %}
<header
  class="masthead"
  style="background-image: url('{{ url_for('static', filename='assets/img/home-bg.jpg') }}')"
>
  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="site-heading">
          <h1>Inbox</h1>
          <span class="subheading">Your Conversations</span>
        </div>
      </div>
    </div>
  </div>
</header>
{% endblock %} {% block content %}
<div class="container px-4 px-lg-5 mb-5 inbox-container">
  <div class="row gx-4 gx-lg-5 justify-content-center">
    <div class="col-md-11 col-lg-9 col-xl-8">
      <div class="card inbox-card border-0 shadow-lg">
        {# Added ID 'conversationList' for JS reordering #}
        <div class="list-group list-group-flush" id="conversationList">
          {% if conversations %} {% for partner_id, data in
          conversations.items() %} {# Added ID 'conversation-{{ partner_id }}'
          for JS targeting #}
          <a
            href="{{ url_for('chat', user_id=partner_id) }}"
            id="conversation-{{ partner_id }}"
            class="list-group-item list-group-item-action p-4 conversation-item d-flex align-items-center {% if data.unread_count > 0 %}unread-active{% endif %}"
          >
            <div class="flex-shrink-0 avatar-wrapper">
              <img
                src="{{ data.user.email | gravatar }}"
                alt="{{ data.user.name }}"
                class="rounded-circle avatar-img"
                width="60"
                height="60"
              />

              {# Updated Badge Logic: Always render, but hide with d-none if 0.
              Added ID. #}
              <span
                id="badge-{{ partner_id }}"
                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger unread-badge {% if data.unread_count == 0 %}d-none{% endif %}"
              >
                {{ data.unread_count }}
              </span>
            </div>

            <div class="ms-4 flex-grow-1 text-content-wrapper">
              <div
                class="d-flex w-100 justify-content-between align-items-center mb-1"
              >
                <h6 class="partner-name mb-0 fw-bold">{{ data.user.name }}</h6>

                {# Added ID 'time-{{ partner_id }}' #} {# DATE FIX: Empty
                content to prevent FOUC. JS fills this instantly. #}
                <small
                  id="time-{{ partner_id }}"
                  class="text-muted smart-date timestamp-small"
                  data-utc="{{ data.last_message.timestamp.isoformat() }}"
                ></small>
              </div>

              {# Added ID 'preview-{{ partner_id }}' #}
              <div
                id="preview-{{ partner_id }}"
                class="last-message-preview"
                data-last-msg-id="{{ data.last_message.id }}"
              >
                {% if data.last_message.is_deleted %}
                <span class="text-muted fst-italic">
                  <i class="bi bi-slash-circle me-1"></i> This message was
                  deleted
                </span>
                {% else %} {% if data.last_message.sender_id == current_user.id
                %}
                <span
                  class="text-primary fw-bold"
                  style="font-size: 0.85rem; margin-right: 4px"
                  >You:</span
                >
                {%- endif -%} {{ data.last_message.body | replace('\n', ' ') |
                truncate(60) | trim }} {% endif %}
              </div>
            </div>

            {#
            <div class="ms-3 text-muted opacity-25 d-none d-md-block">
              <i class="bi bi-chevron-right fs-4"></i>
            </div>
            #}
          </a>
          {% endfor %} {% else %}
          <div class="text-center py-5 px-4">
            <div class="empty-state-icon">
              <i class="bi bi-chat-right-dots fs-1"></i>
            </div>
            <h5 class="fw-bold text-dark">No messages yet</h5>
            <p class="text-muted mx-auto" style="max-width: 400px">
              Connect with other authors. Visit a profile to start your first
              conversation!
            </p>
            <a
              href="{{ url_for('get_all_posts') }}"
              class="btn btn-primary px-4 py-2 rounded-pill mt-3 shadow-sm"
            >
              Explore the Blog
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Use the global socket from base.html
    const socket = window.socket;
    // Capture current user ID for the "You:" logic (Multi-tab support)
    const currentUserId = "{{ current_user.id }}";

    if (socket) {
      // Listen for INCOMING messages to update the list in real-time
      socket.on("new_message", function (data) {
        // Sender ID tells us WHICH conversation row to update
        const senderId = data.sender_id;

        // 1. Find the Row
        const row = document.getElementById(`conversation-${senderId}`);

        // If row exists (it's an existing conversation)
        if (row) {
          // A. Update Preview Text
          const preview = document.getElementById(`preview-${senderId}`);
          if (preview) {
            // 1. Replace ALL newline characters (\n or \r) with a single space
            // 2. Trim excess whitespace
            let cleanText = data.body.replace(/[\n\r]+/g, " ").trim();

            // FIX: Manually truncate to 60 chars to match Jinja's | truncate(60) behavior
            if (cleanText.length > 60) {
              cleanText = cleanText.substring(0, 60) + "...";
            }

            // FIX: Conditional "You:" prefix logic for real-time updates
            // (Handles multi-tab scenarios where I sent the message from another tab)
            if (String(data.sender_id) === String(currentUserId)) {
              preview.innerHTML = `<span class="text-primary fw-bold" style="font-size: 0.85rem; margin-right: 4px;">You:</span>${cleanText}`;
            } else {
              preview.innerText = cleanText; // Update text normally
            }

            preview.style.fontWeight = "700"; // Make it bold
            preview.style.color = "#212529";
            preview.setAttribute("data-last-msg-id", data.id);
          }

          // B. Update Time (DYNAMICALLY using Base Logic)
          const timeEl = document.getElementById(`time-${senderId}`);
          if (timeEl) {
            // 1. Update the Data Attribute to the new time
            timeEl.setAttribute("data-utc", data.timestamp);

            // 2. Use the Global Helper from base.html (Universal Standard)
            if (window.getFriendlyDate) {
              timeEl.innerText = window.getFriendlyDate(data.timestamp);
            }
          }

          // C. Update Badge
          const badge = document.getElementById(`badge-${senderId}`);
          if (badge) {
            let currentCount = parseInt(badge.innerText) || 0;
            badge.innerText = currentCount + 1;
            badge.classList.remove("d-none"); // Ensure visible
          }

          // D. Visual Polish: Add 'unread-active' class to row
          row.classList.add("unread-active");

          // E. Move to Top (The "WhatsApp Effect")
          const listGroup = document.getElementById("conversationList");
          listGroup.prepend(row); // Moves this element to the very top
        } else {
          // Scenario: This is a BRAND NEW conversation not in the list yet.
          // For MVP simplicity: We just force a reload so the Jinja loop runs again.
          location.reload();
        }
      });

      socket.on("message_deleted", function (data) {
        const deletedId = data.message_id;
        // Find the preview element that is currently displaying THIS message ID
        const previewEl = document.querySelector(
          `.last-message-preview[data-last-msg-id="${deletedId}"]`,
        );

        if (previewEl) {
          // Instant Replace
          previewEl.innerHTML = `
                <span class="text-muted fst-italic">
                    <i class="bi bi-slash-circle me-1"></i> This message was deleted
                </span>
            `;
        }
      });
    }
  });
</script>
{% endblock %}
