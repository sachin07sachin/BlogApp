{% macro render_comment(comment, depth, current_user, post) %}
<div id="comment-{{ comment.id }}" class="mb-3">
  <div class="d-flex">
    
    <div class="flex-shrink-0">
      <img
        class="rounded-circle shadow-sm"
        src="{{ comment.comment_author.email | gravatar }}"
        alt="Avatar"
        width="40"
        height="40"
      />
    </div>

    <div class="ms-2 w-100">
      
      <div class="comment-bubble">
        
        <div class="d-flex justify-content-between align-items-center mb-0">
          <div class="d-flex align-items-center">
            <div class="d-flex flex-column me-3">
              <span class="fw-bold text-dark" style="font-size: 0.9rem">
                <a
                  href="{{ url_for('user_profile', username=comment.comment_author.username) }}"
                  class="fw-bold comment-user-link text-dark"
                  style="font-size: 0.9rem"
                >
                  {{ comment.comment_author.name }}
                </a>
                
                {% if comment.timestamp %}
                  <span class="text-muted fw-normal mx-1" style="font-size: 0.8rem">&bull;</span>
                  <span
                    class="text-muted fw-normal smart-date"
                    style="font-size: 0.75rem"
                    data-utc="{{ comment.timestamp.isoformat() }}"
                  >
                    {#{{ comment.timestamp.strftime('%d %b %Y') }}#}
                  </span>
                {% else %}
                  <span class="text-muted fw-normal mx-1" style="font-size: 0.8rem">&bull;</span>
                  <span class="text-muted fw-normal" style="font-size: 0.75rem">(Legacy)</span>
                {% endif %}
              </span>

              <span class="text-muted" style="font-size: 0.75rem">
                @{{ comment.comment_author.username }}
              </span>
            </div>
          </div>
        </div>

        <div class="text-break small mb-0 text-dark">
            {{ comment.text | safe }}
        </div>
      
      </div> 
      <div class="mt-1 ms-1 d-flex align-items-center gap-3">
        
        {% if post.can_comment and current_user.is_authenticated %}
        <button
          class="btn btn-link btn-sm text-decoration-none p-0"
          onclick="setReply('{{ comment.id }}', '{{ comment.comment_author.name }}', '{{ comment.comment_author.username }}')"
        >
          <i class="bi bi-reply-fill small"></i>
          <span class="small">Reply</span>
        </button>
        {% endif %}

        {% if current_user.is_authenticated and (current_user.id == comment.comment_author.id or current_user.role == "admin") %}
        <button
          type="button"
          class="btn btn-link text-danger p-0 border-0 shadow-none delete-btn-anim"
          style="line-height: 1;"
          title="Delete Comment"
          data-bs-toggle="modal"
          data-bs-target="#deleteCommentModal"
          data-delete-url="{{ url_for('delete_comment', comment_id=comment.id) }}"
        >
          <i class="bi bi-trash-fill" style="font-size: 0.95rem;"></i>
        </button>
        {% endif %}

      </div>

      {% if comment.replies %}
      <div class="mt-1">
        <button
          class="btn btn-link btn-sm text-decoration-none p-0 text-muted fw-bold d-flex align-items-center"
          onclick="toggleReplies('{{ comment.id }}', {{ comment.replies|length }})"
          id="btn-replies-{{ comment.id }}"
          style="font-size: 0.8rem"
        >
          <i class="bi bi-chevron-down me-1"></i>
          <span>Show {{ comment.replies|length }} Replies</span>
        </button>
      </div>
      {% endif %}
    </div>
  </div>

  {% if comment.replies %}
  <div
    id="replies-{{ comment.id }}"
    class="mt-2 ms-4 ps-2 border-start"
    style="display: none"
  >
    {% for reply in comment.replies | sort(attribute='timestamp') %} 
      {{ render_comment(reply, depth + 1, current_user, post) }} 
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endmacro %}
