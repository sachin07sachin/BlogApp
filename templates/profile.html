{% extends "base.html" %} 

{% block title %}{{ user.name }} (@{{ user.username }}) | Blog App{% endblock %} 

{% block header %}
<style>
  /* --- GMAIL FAB (Same as Index) --- */
  .gmail-fab {
    position: fixed;
    bottom: 50px; 
    right: 40px;
    z-index: 1000;
    height: 56px;
    padding: 0 24px 0 20px;
    border-radius: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background-color: #0d6efd; 
    color: white !important;
    border: 1px solid #0d6efd; 
    box-shadow: none; 
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: pointer;
    text-decoration: none !important;
    overflow: hidden;
  }

  .gmail-fab:hover {
    background-color: #0b5ed7; 
    border-color: #0a58ca;
    transform: translateY(-2px);
    box-shadow: none; 
  }
  
  .gmail-fab i {
    font-size: 1.2rem;
    position: relative;
    top: -1px;
  }
  
  .gmail-fab span {
    font-weight: 600;
    font-family: 'Segoe UI', sans-serif;
    font-size: 0.95rem;
    white-space: nowrap;
    max-width: 150px;
    opacity: 1;
    transition: max-width 0.4s ease, opacity 0.3s ease, margin 0.3s ease;
  }
  
  .gmail-fab.shrunk {
    width: 56px;
    padding: 0;
    border-radius: 50%;
    gap: 0;
  }
  
  .gmail-fab.shrunk span {
    max-width: 0;
    opacity: 0;
    margin: 0;
  }
  
  @media (max-width: 576px) {
    .gmail-fab {
      bottom: 30px;
      right: 20px;
      height: 50px;
    }
    .gmail-fab.shrunk {
      width: 50px;
    }
  }
</style>

<header
  class="masthead"
  style="background-image: url('{{ url_for('static', filename='assets/img/home-bg.jpg') }}')"
>
  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="site-heading">
          <h1>{{ user.name }}</h1>
          <span class="subheading">@{{ user.username }}</span>
        </div>
      </div>
    </div>
  </div>
</header>
{% endblock %} 

{% block content %}
<div class="container px-4 px-lg-5">
  <div class="row gx-4 gx-lg-5 justify-content-center">
    <div class="col-md-10 col-lg-8 col-xl-7">
      
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div class="card border-0 shadow-sm bg-body-tertiary mb-5">
        <div class="card-body p-4 text-center">
          <div class="mb-3">
            <img
              src="{{ user.email | gravatar }}"
              alt="{{ user.name }}"
              class="rounded-circle shadow-sm"
              width="100"
              height="100"
            />
          </div>

          <h4 class="fw-bold mb-1">{{ user.name }}</h4>
          <p class="text-muted small mb-3">@{{ user.username }}</p>

          {% if user.about_me %}
            <p class="card-text text-muted mb-4 px-lg-5">{{ user.about_me }}</p>
          {% else %}
          {% if current_user.is_authenticated and current_user.id == user.id %}
            <p class="card-text text-muted fst-italic mb-4">
              You have not written a bio yet.
            </p>
            {% else %}
            <p class="card-text text-muted fst-italic mb-4">
              This user has not written a bio yet.
            </p>
            {% endif %}
          {% endif %} 
          
          {% if current_user.is_authenticated and current_user.id == user.id %}
          <div class="d-flex justify-content-center gap-4 text-muted small">
            <div>
              <i class="bi bi-pen-fill me-1"></i>
              <span class="fw-bold">{{ posts|length }}</span> Posts
            </div>
          </div>
            <a
              href="{{ url_for('settings') }}"
              class="btn btn-outline-primary btn-sm rounded-pill px-4"
            >
              <i class="bi bi-pencil-square me-1"></i> Edit Profile
            </a>
          {% else %}
            <div class="d-flex justify-content-center gap-4 text-muted small">
              <div>
                <i class="bi bi-pen-fill me-1"></i>
                <span class="fw-bold">{{ posts|length }}</span> Posts
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      {% if current_user.is_authenticated and current_user.id == user.id %}
      <div class="card border-0 shadow-sm mb-5">
        <div class="card-body p-3 d-flex align-items-center">
            <div class="flex-shrink-0 me-3">
                <img class="rounded-circle" src="{{ current_user.email | gravatar }}" alt="User" width="40" height="40">
            </div>
            <div class="w-100">
                <a href="{{ url_for('add_new_post') }}" class="btn btn-light text-start w-100 rounded-pill text-muted px-3" style="background-color: #f0f2f5;">
                    What's on your mind, {{ current_user.name.split()[0] }}?
                </a>
            </div>
        </div>
      </div>
      {% endif %}

      <h5 class="fw-bold border-bottom pb-3 mb-4">
        <i class="bi bi-journal-text me-2"></i>Recent Posts
      </h5>

      {% if posts|length > 0 %}

        {% for post in posts %}
          <div class="post-preview">
            <a href="{{ url_for('show_post', post_id=post.id) }}">
              <h2 class="post-title">{{ post.title }}</h2>
              <h3 class="post-subtitle">{{ post.subtitle }}</h3>
            </a>
            <p class="post-meta">
              Posted on {{ post.date.strftime('%B %d, %Y') }}

              {% if current_user.is_authenticated and current_user.role == "admin" %}
              <a 
                 href="{{ url_for('warn_post_author', post_id=post.id) }}" 
                 class="btn btn-warning btn-sm ms-3"
                 style="font-size: 0.7rem;"
              >
                 Warn
              </a>
            {% endif %}
              
              {% if current_user.is_authenticated and (current_user.id == post.author.id or current_user.role == "admin") %}
                <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" class="d-inline ms-2" onsubmit="return confirm('Delete this post?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  <button type="submit" class="btn btn-danger btn-sm" style="font-size: 0.7rem;">Delete</button>
                </form>
              {% endif %}
            </p>
          </div>
          <hr class="my-4" />
        {% endfor %} 
      
      {% else %}
        
        <div class="text-center py-5 text-muted">
          <i class="bi bi-journal-x fs-1 mb-3 d-block"></i>
          <p>No posts published yet.</p>

          {% if current_user.is_authenticated and current_user.id == user.id %}
             <a href="{{ url_for('add_new_post') }}" class="btn btn-primary btn-lg rounded-pill px-4 shadow-sm mt-3">
                <i class="bi bi-pen-fill me-2"></i>Write the First Post
             </a>
          {% endif %}
        </div>

      {% endif %}

    </div>
  </div>
</div>

{% if current_user.is_authenticated and current_user.id == user.id and posts|length > 0 %}
<a 
  href="{{ url_for('add_new_post') }}" 
  class="gmail-fab" 
  id="composeButton"
  title="Create New Post"
>
  <i class="bi bi-pencil-fill"></i>
  <span>Create New Post</span>
</a>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
      const fab = document.getElementById('composeButton');
      const footer = document.querySelector('footer');
      
      if (fab) {
          let lastScrollY = window.scrollY;
          const defaultBottom = 50; 
          const gapAboveFooter = 20; 
          
          window.addEventListener('scroll', () => {
              const currentScrollY = window.scrollY;
              
              // 1. SHRINK LOGIC
              if (currentScrollY > lastScrollY + 10) {
                  fab.classList.add('shrunk');
              } else if (currentScrollY < lastScrollY - 10) {
                  fab.classList.remove('shrunk');
              }
              lastScrollY = currentScrollY;

              // 2. FOOTER COLLISION LOGIC
              if (footer) {
                  const footerRect = footer.getBoundingClientRect();
                  const visibleFooterHeight = window.innerHeight - footerRect.top;

                  if (visibleFooterHeight > 0) {
                      const newBottom = Math.max(defaultBottom, visibleFooterHeight + gapAboveFooter);
                      fab.style.bottom = `${newBottom}px`;
                  } else {
                      fab.style.bottom = `${defaultBottom}px`;
                  }
              }
          });
      }
  });
</script>
{% endblock %}
