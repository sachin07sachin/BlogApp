{% extends "base.html" %} {% block header %}
<style>
  /* --- IMAGE PREVIEW STYLES --- */
  .image-preview-container {
    width: 100%;
    aspect-ratio: 16 / 9;
    background-color: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
    transition: all 0.3s ease;
  }

  /* State: Valid Image Loaded */
  .image-preview-container.has-image {
    border: none;
    background-color: transparent;
  }

  /* State: Error Loading Image */
  .image-preview-container.has-error {
    border-color: #dc3545; /* Bootstrap danger color */
    background-color: #fff5f6;
  }

  .image-preview-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
  }

  .preview-placeholder,
  .preview-error-message {
    text-align: center;
    padding: 1rem;
  }

  .preview-placeholder {
    color: #adb5bd;
  }

  /* Hidden by default, shown via JS on error */
  .preview-error-message {
    color: #dc3545;
    display: none;
  }

  /* --- HYBRID INPUT STYLES --- */
  /* Visual cue when a file is selected (looks like a 'chip' or locked state) */
  .form-control.file-selected {
    background-color: #e9ecef; /* Bootstrap gray-200 */
    color: #495057;
    font-style: italic;
    cursor: default;
  }

  /* --- SUBMIT BUTTON DISABLED STATE (Gatekeeper UI) --- */
  /* Ensures the user visually understands the button is dead */
  input[type="submit"]:disabled {
    cursor: not-allowed !important;
    opacity: 0.6 !important;
    pointer-events: none;
  }
</style>

<header
  class="masthead"
  style="background-image: url('{{ url_for('static', filename='assets/img/edit-bg.jpg') }}')"
>
  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="page-heading">
          {% if is_edit %}
          <h1>Edit Post</h1>
          <span class="subheading">Refine your content.</span>
          {% else %}
          <h1>New Post</h1>
          <span class="subheading">Share your story with the world.</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</header>
{% endblock %} {% block content %}
<main class="mb-4">
  <div class="container px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8">
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %} {% for category, message in messages %}
        <div
          class="alert alert-{{ category }} alert-dismissible fade show shadow-sm mb-4"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
          ></button>
        </div>
        {% endfor %} {% endif %} {% endwith %}
      </div>

      <div class="col-md-10 col-lg-8 col-xl-7">
        <form
          method="POST"
          enctype="multipart/form-data"
          novalidate
          id="postForm"
        >
          {{ form.hidden_tag() }}

          <div class="mb-5">
            <label class="form-label fw-bold text-muted small text-uppercase"
              >Cover Image</label
            >

            <div
              class="image-preview-container mb-3 shadow-sm"
              id="preview-box"
            >
              <div class="preview-placeholder" id="preview-placeholder">
                <i class="bi bi-card-image fs-1 d-block mb-2"></i>
                <span class="small fw-bold">Image Preview</span><br />
                <span class="small text-muted">No image selected</span>
              </div>

              <div class="preview-error-message" id="preview-error-message">
                <i class="bi bi-exclamation-circle-fill fs-1 d-block mb-2"></i>
                <span class="fw-bold">Failed to Load</span><br />
                <span class="small" id="error-text-detail"
                  >Invalid source.</span
                >
              </div>

              <img
                id="image-preview"
                src="{{ form.img_url.data if form.img_url.data else '' }}"
                alt="Cover Preview"
              />
            </div>

            <div class="input-group has-validation shadow-sm">
              {# {% set input_class = "form-control is-invalid" if
              form.img_url.errors or form.img_file.errors else "form-control" %}#}
              {{ form.img_url(class="form-control", id="hybrid_input",
              placeholder="Paste an image URL or upload a file...",
              maxlength="") }}

              <button
                class="btn btn-outline-secondary border-start-0 border-end-0"
                style="border: 1px solid #ced4da;"
                type="button"
                id="btn-clear"
                title="Clear input"
              >
                <i class="bi bi-x-lg"></i>
              </button>

              <button
                class="btn btn-outline-secondary bg-light text-dark"
                type="button"
                id="btn-upload-trigger"
                title="Choose file from device"
              >
                <i class="bi bi-folder2-open"></i>
              </button>

              {{ form.img_file(class="d-none", id="hidden_file_input") }} {#{% for
              error in form.img_url.errors %}
              <div class="invalid-feedback d-block ms-1 my-1">
                <strong>URL Error:</strong> {{ error }}
              </div>
              {% endfor %} {% for error in form.img_file.errors %}
              <div class="invalid-feedback d-block ms-1 my-1">
                <strong>File Error:</strong> {{ error }}
              </div>
              {% endfor %}#}
            </div>

            <div class="form-text text-muted small mt-2">
              Supported: png, jpeg, gif, webp. Best fit: <strong>16:9</strong> ratio. Max Size: <strong>8MB</strong>.
            </div>
          </div>

          <div class="form-floating mb-3">
            {{ form.title(class="form-control", placeholder="Title",
            style="font-weight: 600;") }} {{ form.title.label }} {% for error in
            form.title.errors %}
            <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="form-floating mb-4">
            {{ form.subtitle(class="form-control", placeholder="Subtitle") }} {{
            form.subtitle.label }} {% for error in form.subtitle.errors %}
            <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="mb-4">
            {{ form.body.label(class="form-label fw-bold small text-uppercase")
            }} {{ form.body(class="form-control", id="body") }} {% for error in
            form.body.errors %}
            <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="card bg-light border-0 mb-5 rounded-3">
            <div class="card-body p-3">
              <div
                class="form-check form-switch d-flex align-items-center ps-5"
              >
                {{ form.can_comment(class="form-check-input", style="cursor:
                pointer; width: 3em; height: 1.5em; margin-left: -3.5em;") }}
                <div class="ms-3">
                  <label class="form-check-label fw-bold" for="can_comment"
                    >Enable Comments</label
                  >
                  <div class="text-muted small" style="line-height: 1.2">
                    Allow users to discuss this post.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div
            class="d-grid gap-2 d-md-flex justify-content-md-end align-items-center"
          >
            <a
              href="{{ url_for('get_all_posts') }}"
              onclick="
                if (
                  document.referrer &&
                  document.referrer.indexOf(window.location.host) !== -1
                ) {
                  history.back();
                  return false;
                }
              "
              class="btn btn-outline-secondary rounded-pill px-4 me-2"
            >
              Cancel
            </a>

            {% if is_edit %} {{ form.submit(class="btn btn-primary rounded-pill
            px-5 shadow-sm fw-bold", value="Update Post", id="submitBtn") }} {%
            else %} {{ form.submit(class="btn btn-success rounded-pill px-5
            shadow-sm fw-bold", value="Publish Post", id="submitBtn") }} {%
            endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
</main>
{% endblock %} {% block scripts %}
<script
  src="https://cdn.tiny.cloud/1/{{ config['TINYMCE_API_KEY'] }}/tinymce/6/tinymce.min.js"
  referrerpolicy="origin"
></script>

<script>
  tinymce.init({
    selector: "#body",
    height: 500,
    menubar: true,
    plugins: [
      "advlist",
      "autolink",
      "lists",
      "link",
      "image",
      "charmap",
      "preview",
      "anchor",
      "searchreplace",
      "visualblocks",
      "code",
      "fullscreen",
      "media",
      "table",
      "help",
      "wordcount",
      "emoticons",
    ],
    toolbar:
      "undo redo | blocks | " +
      "bold italic backcolor | alignleft aligncenter " +
      "alignright alignjustify | bullist numlist outdent indent | " +
      "removeformat | help",
    content_style:
      "body { font-family:Inter,Helvetica,Arial,sans-serif; font-size:14px; line-height: 1.6; }",
    automatic_uploads: true,
    file_picker_types: "image",
  });

  document.addEventListener("DOMContentLoaded", function () {
    // --- ELEMENT REFERENCES ---
    const hybridInput = document.getElementById("hybrid_input");
    const hiddenFileInput = document.getElementById("hidden_file_input");
    const btnUpload = document.getElementById("btn-upload-trigger");
    const btnClear = document.getElementById("btn-clear");
    const submitBtn = document.getElementById("submitBtn"); // Target for blocking

    const previewBox = document.getElementById("preview-box");
    const previewImg = document.getElementById("image-preview");
    const placeholder = document.getElementById("preview-placeholder");
    const errorMessage = document.getElementById("preview-error-message");
    const errorDetail = document.getElementById("error-text-detail");

    const allowedMimeTypes = [
      "image/jpeg",
      "image/png",
      "image/gif",
      "image/webp",
    ];
    const defaultPlaceholder = "Paste an image URL or upload a file...";

    // --- GATEKEEPER LOGIC (Enable/Disable Submit) ---
    // This solves the issue of users submitting broken/invalid images

    function disableSubmit() {
      if (submitBtn) submitBtn.disabled = true;
    }

    function enableSubmit() {
      if (submitBtn) submitBtn.disabled = false;
    }

    // --- UI STATE MANAGERS ---

    function showImage(src) {
      clearError();
      previewImg.src = src;
      previewImg.style.display = "block";
      placeholder.style.display = "none";
      previewBox.classList.add("has-image");
      enableSubmit(); // Valid image loaded -> Allow submit
    }

    function resetPreview() {
      clearError();
      previewImg.style.display = "none";
      previewImg.removeAttribute("src");
      placeholder.style.display = "block";
      previewBox.classList.remove("has-image");
      // If field is empty, allow submit (Backend handles 'Required' check if needed)
      enableSubmit();
    }

    function showError(msg) {
      previewImg.style.display = "none";
      placeholder.style.display = "none";
      previewBox.classList.remove("has-image");
      previewBox.classList.add("has-error");
      errorMessage.style.display = "block";
      if (msg) errorDetail.textContent = msg;
      disableSubmit(); // Invalid state -> Block submit
    }

    function clearError() {
      previewBox.classList.remove("has-error");
      errorMessage.style.display = "none";
    }

    // --- CORE HANDLERS ---

    // 1. Upload Click
    btnUpload.addEventListener("click", function () {
      hiddenFileInput.click();
    });

    // 2. File Selection (UPDATED WITH SIZE CHECK)
    hiddenFileInput.addEventListener("change", function (e) {
      const file = e.target.files[0];
      const MAX_FILE_SIZE = 8 * 1024 * 1024; // 8MB Limit (Matches Backend)

      if (file) {
        // A. Check Type
        if (!allowedMimeTypes.includes(file.type)) {
          showError("Invalid file type. Use JPG, PNG, GIF, or WebP.");
          hiddenFileInput.value = "";
          return;
        }

        // B. Check Size (CRITICAL UPDATE)
        if (file.size > MAX_FILE_SIZE) {
          showError("File is too large. Maximum size is 8MB.");
          hiddenFileInput.value = "";
          return;
        }

        // Update UI to "File Mode"
        hybridInput.value = "";
        hybridInput.setAttribute("placeholder", `Selected: ${file.name}`);
        hybridInput.setAttribute("readonly", true);
        hybridInput.classList.add("file-selected");

        const reader = new FileReader();
        reader.onload = function (e) {
          showImage(e.target.result);
        };
        reader.onerror = function () {
          showError("Error reading file.");
          hiddenFileInput.value = "";
        };
        reader.readAsDataURL(file);
      }
    });

    // 3. Text Typing
    hybridInput.addEventListener(
      "input",
      debounce(function () {
        const url = hybridInput.value.trim();

        // Clear file if user types
        if (hiddenFileInput.value) {
          hiddenFileInput.value = "";
          hybridInput.removeAttribute("readonly");
          hybridInput.classList.remove("file-selected");
          hybridInput.setAttribute("placeholder", defaultPlaceholder);
        }

        if (url) {
          // 1. Length Check (Matches Backend 2048 char limit)
          if (url.length > 2048) {
            showError("URL is too long (max 2048 characters).");
            return;
          }

          // 2. Strict URL Format Check
          // Matches http:// or https:// (case insensitive)
          if (url.match(/^https?:\/\//i)) {
            showImage(url); 
          } else {
            // FIX: If it has text but isn't a URL, show error immediately
            showError("Invalid URL. Must start with http:// or https://");
          }
        } else {
          // Only reset if the field is actually empty
          resetPreview();
        }
      }, 500), // Increased debounce to 500ms to avoid flashing errors while typing "https"
    );

    // 4. Clear Button
    btnClear.addEventListener("click", function () {
      hybridInput.value = "";
      hiddenFileInput.value = "";
      hybridInput.removeAttribute("readonly");
      hybridInput.classList.remove("file-selected");
      hybridInput.setAttribute("placeholder", defaultPlaceholder);
      resetPreview();
      enableSubmit(); // Resetting clears errors
    });

    // 5. Image Load Error (The Critical Catch-All)
    // If the browser fails to load the image (404, CORS, Corrupt), block submit.
    previewImg.onerror = function () {
      if (this.getAttribute("src")) {
        showError("Unable to load image. Check URL or file.");
      }
    };

    // --- UTILITIES ---

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // --- INITIAL LOAD ---
    // 1. Check for Backend Errors via Jinja
    // We combine URL errors and File errors into one variable
    {% set backend_error = None %}
    {% if form.img_url.errors %}
      {% set backend_error = form.img_url.errors[0] %}
    {% elif form.img_file.errors %}
      {% set backend_error = form.img_file.errors[0] %}
    {% endif %}

    // Inject into JS (safe string formatting)
    const backendErrorMsg = {{ backend_error|tojson if backend_error else 'null' }};
    const initialSrc = previewImg.getAttribute("src");

    // 2. Priority Logic: Error > Image > Empty
    if (backendErrorMsg) {
        // If Flask says it's wrong (e.g. "File too large"), show that error immediately
        showError(backendErrorMsg);
    } else if (initialSrc && initialSrc !== "" && initialSrc !== "None") {
        showImage(initialSrc);
    } else {
        resetPreview();
    }

    // --- AUTO-SCROLL TO ERRORS ---
    const flashMessage = document.querySelector(".alert");
    const formError = document.querySelector(".invalid-feedback, .text-danger, .image-preview-container.has-error");
    const target = flashMessage || formError;

    if (target && target.offsetParent !== null) {
      setTimeout(() => {
        target.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 100);
    }
  });
</script>
{% endblock %}
