{% extends "base.html" %}

{% block header %}
<header class="masthead" style="background-image: url('{{ post.img_url }}')">
  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="post-heading">
          <h1>{{ post.title }}</h1>
          <h2 class="subheading">{{ post.subtitle }}</h2>
          <span class="meta">
            Posted by
            <b>{{ post.author.name }}</b>
            on {{ post.date.strftime('%B %d, %Y') }}
          </span>
        </div>
      </div>
    </div>
  </div>
</header>
{% endblock %}

{% block content %}
<article>
  <div class="container px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">

        {{ post.body | safe }}

        <div class="d-flex justify-content-end mb-4">
            
            {% if current_user.is_authenticated and current_user.role == "admin" %}
              <a class="btn btn-warning me-2" href="{{ url_for('warn_post_author', post_id=post.id) }}">
                Warn User
              </a>
            {% endif %}

            {% if current_user.is_authenticated and current_user.id == post.author.id %}
              <a class="btn btn-primary me-2" href="{{ url_for('edit_post', post_id=post.id) }}">
                Edit Post
              </a>
            {% endif %}

            {% if current_user.is_authenticated and (current_user.id == post.author.id or current_user.role == "admin") %}
              <form
                method="POST"
                action="{{ url_for('delete_post', post_id=post.id) }}"
                class="d-inline"
                onsubmit="return confirm('Are you sure you want to delete this post?');"
              >
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-danger">
                  Delete Post
                </button>
              </form>
            {% endif %}

        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% if current_user.is_authenticated %}
          <form method="POST" action="{{ url_for('show_post', post_id=post.id) }}" novalidate>
            {{ form.hidden_tag() }}

            <div class="mb-3">
              {{ form.comment_text.label(class="form-label") }}
              
              {{ form.comment_text(class="form-control", id="comment_text") }}
              
              {% if form.comment_text.errors %}
                <div class="text-danger">
                  {% for error in form.comment_text.errors %}
                    <small>{{ error }}</small>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <button type="submit" class="btn btn-primary">
              Submit Comment
            </button>
          </form>
        {% else %}
        <div class="card bg-light border-0 mt-4">
          <div class="card-body text-center py-4">
            <h5 class="card-title text-muted mb-3">Join the conversation</h5>
            <p class="card-text mb-3">Leave a comment and share your thoughts with the community.</p>
            <a href="{{ url_for('login_get') }}" class="btn btn-primary px-4 rounded-pill">
              Log In to Comment
            </a>
          </div>
        </div>
        {% endif %}

        <div class="mt-5 mb-4">
          <h3 class="border-bottom pb-2">
              Comments 
              <span class="text-muted" style="font-size: 0.8em;">({{ post.comments|length }})</span>
          </h3>
      </div>

        <div class="comment">
          <ul class="commentList">
            {% for comment in post.comments %}
              <li class="mb-4">
                <div class="commenterImage">
                  <img src="{{ comment.comment_author.email | gravatar }}" />
                </div>
                <div class="commentText">
                  <span class="sub-text">{{ comment.comment_author.name }}
                    {% if current_user.is_authenticated and (current_user.id == comment.comment_author.id or current_user.role == "admin") %}
                      <form
                        method="POST"
                        action="{{ url_for('delete_comment', comment_id=comment.id) }}"
                        class="d-inline"
                        onsubmit="return confirm('Are you sure you want to delete this comment?');"
                      >
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <button
                          type="submit"
                          class="btn btn-danger btn-sm ms-2"
                          style="font-size: 0.6rem; padding: 2px 6px;"
                        >
                          Delete
                        </button>
                        
                      </form>
                    {% endif %}
                  </span>
                  {{ comment.text | safe }}
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>

      </div>
    </div>
  </div>
</article>
{% endblock %}

{% block scripts %}
<script src="https://cdn.tiny.cloud/1/{{ config['TINYMCE_API_KEY'] }}/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

<script>
  tinymce.init({
    selector: '#comment_text',
    height: 300,
    menubar: false, // Cleaner for comments
    statusbar: false,
    // Lighter plugins including Emoticons for social interaction
    plugins: [
      'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
      'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
      'media', 'table', 'help', 'wordcount', 'emoticons'
    ],
    // Simplified Toolbar for users
    toolbar: 'bold italic | alignleft aligncenter alignright | ' +
      'bullist numlist | link image emoticons',
    content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }',
    
    image_title: true,
    automatic_uploads: true,
    file_picker_types: 'image',
  });
</script>
{% endblock %}
