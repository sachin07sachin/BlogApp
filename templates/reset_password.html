{% extends "base.html" %} {% block styles %}
<style>
  /* 1. Fix for the border disappearing on focus */
  .input-group .form-control:focus {
    z-index: 3;
  }

  .input-group .btn-outline-secondary {
    border-color: #ced4da;
    z-index: 2;
  }

  /* Ensures the eye button borders stay visible and color-synced during focus */
  .input-group:focus-within .btn-outline-secondary {
    border-color: #80c2d0;
    z-index: 5 !important;
  }

  /* Consistent Footer Link Styling */
  .auth-link {
    color: #0085a1;
    font-weight: 600;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .auth-link:hover {
    color: #005f73;
    text-decoration: underline !important;
  }

  /* --- NEW: PASSWORD FEEDBACK STYLING --- */
  #pwd-criteria {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
  }

  /* Valid State (Green) */
  .rule-valid {
    color: #198754 !important; /* Bootstrap Success Green */
    font-weight: 600;
    transition: color 0.2s ease;
  }

  /* Invalid/Pending State (Gray) */
  .rule-invalid {
    color: #6c757d !important; /* Bootstrap Muted */
  }
</style>
{% endblock %} {% block header %}
<header
  class="masthead"
  style="background-image: url('{{ url_for('static', filename='assets/img/login-bg.jpg') }}')"
>
  <div class="container position-relative px-4 px-lg-5">
    <div class="row gx-4 gx-lg-5 justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <div class="page-heading">
          <h1>Reset Password</h1>
        </div>
      </div>
    </div>
  </div>
</header>
{% endblock %} {% block content %}
<main class="mb-4">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %} {% for category, message in messages %}
        <div
          class="alert alert-{{ category }} alert-dismissible fade show"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
          ></button>
        </div>
        {% endfor %} {% endif %} {% endwith %}
      </div>

      <div class="col-lg-6 col-md-8 mx-auto">
        <div class="card border-0 shadow rounded-3 my-3">
          <div class="card-body p-4 p-sm-5">
            <h3 class="card-title text-center mb-4 fw-light fs-4">
              Set New Password
            </h3>

            <form method="POST" novalidate>
              {{ form.hidden_tag() }}

              <div class="mb-3">
                <div class="input-group">
                  <div class="form-floating flex-grow-1">
                    {{ form.password(class="form-control rounded-end-0",
                    id="reset-pass-1", placeholder="New Password") }} {{
                    form.password.label() }}
                  </div>
                  <button
                    class="btn btn-outline-secondary px-3"
                    type="button"
                    onclick="togglePassword('reset-pass-1', 'icon-1')"
                  >
                    <i class="bi bi-eye" id="icon-1"></i>
                  </button>
                </div>
                {% if form.password.errors %}
                <div class="text-danger mt-1">
                  {% for error in form.password.errors %}
                  <small
                    ><i class="bi bi-exclamation-circle"></i> {{ error }}</small
                  >
                  {% endfor %}
                </div>
                {% endif %}
                <div id="pwd-criteria" class="mt-2 d-none">
                  <small class="text-muted fw-bold"
                    >Password must contain:</small
                  >
                  <ul class="list-unstyled mb-0 small mt-1">
                    <li id="rule-len" class="text-muted">
                      <i class="bi bi-circle me-1"></i> 8-128 characters
                    </li>
                    <li id="rule-upper" class="text-muted">
                      <i class="bi bi-circle me-1"></i> Uppercase letter (A-Z)
                    </li>
                    <li id="rule-lower" class="text-muted">
                      <i class="bi bi-circle me-1"></i> Lowercase letter (a-z)
                    </li>
                    <li id="rule-num" class="text-muted">
                      <i class="bi bi-circle me-1"></i> Number (0-9)
                    </li>
                    <li id="rule-spec" class="text-muted">
                      <i class="bi bi-circle me-1"></i> Special char (!@#$...)
                    </li>
                  </ul>
                </div>
              </div>

              <div class="mb-3">
                <div class="input-group">
                  <div class="form-floating flex-grow-1">
                    {{ form.confirm_password(class="form-control rounded-end-0",
                    id="reset-pass-2", placeholder="Confirm Password") }} {{
                    form.confirm_password.label() }}
                  </div>
                  <button
                    class="btn btn-outline-secondary px-3"
                    type="button"
                    onclick="togglePassword('reset-pass-2', 'icon-2')"
                  >
                    <i class="bi bi-eye" id="icon-2"></i>
                  </button>
                </div>
                {% if form.confirm_password.errors %}
                <div class="text-danger mt-1">
                  {% for error in form.confirm_password.errors %}
                  <small
                    ><i class="bi bi-exclamation-circle"></i> {{ error }}</small
                  >
                  {% endfor %}
                </div>
                {% endif %}
              </div>

              <div class="d-grid mt-4">
                <button
                  type="submit"
                  class="btn btn-success btn-lg text-uppercase fw-bold"
                  style="letter-spacing: 1px"
                >
                  Reset Password
                </button>
              </div>
            </form>
          </div>

          <div class="card-footer text-center py-4 border-0 bg-transparent">
            <p class="small mb-0">
              <i class="bi bi-arrow-left text-muted me-1"></i>
              <a href="{{ url_for('login_get') }}" class="auth-link"
                >Back to Log In</a
              >
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %} {% block scripts %}
<script>
  // Reusable function for multiple password fields
  function togglePassword(fieldId, iconId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(iconId);

    const type =
      field.getAttribute("type") === "password" ? "text" : "password";
    field.setAttribute("type", type);

    if (type === "text") {
      icon.classList.remove("bi-eye");
      icon.classList.add("bi-eye-slash");
    } else {
      icon.classList.remove("bi-eye-slash");
      icon.classList.add("bi-eye");
    }
  }

  // --- 2. NEW: AUTO-SCROLL TO ERRORS/ALERTS ---
  document.addEventListener("DOMContentLoaded", () => {
    // Target the main container
    const mainContainer = document.querySelector("main");

    // Check for Flash Messages (Bootstrap Alerts)
    const hasFlashMessages = document.querySelector(".alert");

    // Check for Validation Errors (Text Danger)
    const hasValidationErrors = document.querySelector(".text-danger");

    // If the container exists AND (we have an alert OR a form error)
    if (mainContainer && (hasFlashMessages || hasValidationErrors)) {
      // Smoothly scroll to the top so the message is center stage
      mainContainer.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // --- 3. REAL-TIME PASSWORD VALIDATION ---
    // Note: We target 'reset-pass-1' here
    const passwordInput = document.getElementById("reset-pass-1");
    const criteriaBox = document.getElementById("pwd-criteria");

    // The Rules (Matching Python & Register.html)
    const rules = {
      len: (val) => val.length >= 8 && val.length <= 128,
      upper: (val) => /[A-Z]/.test(val),
      lower: (val) => /[a-z]/.test(val),
      num: (val) => /\d/.test(val),
      spec: (val) => /[^a-zA-Z0-9]/.test(val), // Industry Standard Regex
    };

    if (passwordInput && criteriaBox) {
      // A. Show Box on Focus
      passwordInput.addEventListener("focus", () => {
        criteriaBox.classList.remove("d-none");
      });

      // B. Hide Box on Blur (only if empty)
      passwordInput.addEventListener("blur", () => {
        if (passwordInput.value === "") {
          criteriaBox.classList.add("d-none");
        }
      });

      // C. Check Input as User Types
      passwordInput.addEventListener("input", function () {
        const val = this.value;

        for (const [id, checkFn] of Object.entries(rules)) {
          const item = document.getElementById(`rule-${id}`);
          const icon = item.querySelector("i");

          if (checkFn(val)) {
            // Success State
            item.classList.remove("rule-invalid");
            item.classList.add("rule-valid");
            icon.classList.remove("bi-circle");
            icon.classList.add("bi-check-circle-fill");
          } else {
            // Pending State
            item.classList.remove("rule-valid");
            item.classList.add("rule-invalid");
            icon.classList.remove("bi-check-circle-fill");
            icon.classList.add("bi-circle");
          }
        }
      });
    }
  });
</script>
{% endblock %}
